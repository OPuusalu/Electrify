<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Electrify</title>
    <style>
      html, body {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        background: #fff;
        font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      }
      *, *::before, *::after { box-sizing: inherit; }

      /* center the card content and make it fill the window */
      .card {
        width: 100vw;
        height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center; /* vertical + horizontal centering */
        text-align: center;
        padding: 20px;
      }

      h1 { margin: 0 0 8px 0; font-size: 18px; }
      #price { font-size: 34px; font-weight: 600; margin: 6px 0; }
      #time { color: #666; margin-top: 8px; }
      #status { margin-top: 10px; color: #b00; font-size: 13px; }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>Praegune hind</h1>
      <div id="price">Laadin…</div>
      <div id="time"></div>
      <div id="status"></div>
    </div>

    <script>
      const { ipcRenderer } = require('electron');

      const priceEl = document.getElementById('price');
      const timeEl = document.getElementById('time');
      const statusEl = document.getElementById('status');

      function pad(n){ return String(n).padStart(2,'0'); }

      // Round down to nearest quarter
      function currentQuarterDate() {
        const now = new Date();
        const q = Math.floor(now.getMinutes() / 15) * 15;
        const d = new Date(now);
        d.setMinutes(q, 0, 0);
        return d;
      }

      function formatQuarter(date) {
        return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())} ${pad(date.getHours())}:${pad(date.getMinutes())}`;
      }

      // ms until next quarter boundary
      function msUntilNextQuarter() {
        const now = new Date();
        const currQuarter = Math.floor(now.getMinutes() / 15) * 15;
        const next = new Date(now);
        next.setMinutes(currQuarter + 15, 0, 0);
        return Math.max(0, next.getTime() - now.getTime());
      }

      // ask main for price (main will fetch & save if needed)
      async function fetchPriceForNow() {
        const q = currentQuarterDate();
        const key = formatQuarter(q);
        try {
          const resp = await ipcRenderer.invoke('get-price-for-quarter', key);
          return { q, key, resp };
        } catch (err) {
          return { q, key, error: String(err) };
        }
      }

      async function updateDisplay() {
        statusEl.textContent = '';
        priceEl.textContent = 'Laadin…';
        timeEl.textContent = '';

        const { q, key, resp, error } = await fetchPriceForNow();
        if (error) {
          priceEl.textContent = 'Viga';
          statusEl.textContent = error;
          return;
        }

        if (resp && resp.price != null) {
          priceEl.textContent = `${resp.price} senti/kWh`;
          timeEl.textContent = `Kell: ${q.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} (${key})`;
          statusEl.textContent = '';
        } else {
          priceEl.textContent = 'Andmeid ei leitud';
          timeEl.textContent = `Kvartal: ${key}`;
          statusEl.textContent = resp && resp.error ? `Viga: ${resp.error}` : 'Fail puudub või pole JSON-i parsitud.';
        }
      }

      // schedule updates exactly on quarter boundaries
      async function scheduleUpdates() {
        await updateDisplay();
        const delay = msUntilNextQuarter();
        setTimeout(() => {
          updateDisplay().catch(() => {});
          setInterval(() => updateDisplay().catch(() => {}), 15 * 60 * 1000);
        }, delay);
      }

      // react to main's immediate notifications when data file is created/changed
      ipcRenderer.on('data-file-changed', (event, filename) => {
        // optional optimization: inspect filename to decide whether to refresh
        console.log('data-file-changed', filename);
        updateDisplay().catch(err => console.error('updateDisplay after file change failed', err));
      });

      // start
      scheduleUpdates().catch(err => { statusEl.textContent = String(err); });
    </script>
  </body>
</html>